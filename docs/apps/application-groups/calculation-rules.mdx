---
title: "Calculation Rules"
sidebar_position: 1
---

import ThemedImage from '@theme/ThemedImage'
import useBaseUrl from '@docusaurus/useBaseUrl'
import statusImage from '/assets/images/calculation-rules/calc-rule-execution-statuses.png'

:::note
In 19.05, AppFocus Filters were renamed **Application Group Calculation Rules** and AppFocus Groups were renamed **Application Groups**. 
:::

# The Revised ADM Workflow

In 19.05, we updated our Application Dependency Mapping (ADM) workflow to make it easier to create and manage Application Groups, and ultimately, Business Services (previously known as Business Applications).

The [ADM workflow](/apps/enterprise-application-dependency-mapping) starts by defining Starting Points and setting traversal rules and stop points (using logic templates) to generate Application Groups. Use Application Groups (along with Application Components, resources, and devices) to build a complete and focused picture of your IT environment as a business service.

![ADM Workflow](/assets/images/calculation-rules/adm-flow.png)

When defining rules, you can elect to immediately create the groups upon processing or instruct the rules to output suggestions that you can accept or ignore. Device42 suggests Application Groups based on Application Components – you can accept or ignore these suggestions, too.

You can optionally use Device42's predefined rules, which are based on common use cases. You can disable or change the outcomes of these rules, but they are maintained by Device42 and cannot be edited.

## What are Calculation Rules?

Calculation Rules give you the flexibility and control to define the generation of Application Groups that accurately represent important communication groups in your environment. If you're not sure where to start, you can use one of our predefined rules to quickly create Application Groups based on common use cases.

Choose Starting Points based on what you want the resulting Application Group to focus on, such as a service, database, or Saturn application. You can set fixed Starting Points with known items or dynamically find items based on search criteria, which you can define using object types (Application Components, Devices, and Service Instances) or even tags.

The Calculation Rule form contains Starting Points that you can think of as 'seeds' highlighting what's important and indicating what Device42 should consider as dependencies. 

The Starting Point(s) you choose will be visible in the AppFocus container in the chart. For example:

<ThemedImage
  alt="Docusaurus themed image"
  sources={{
    light: useBaseUrl('/assets/images/calculation-rules/10.92.11.208_admin_core_applicationgroup-light.png'),
    dark: useBaseUrl('/assets/images/calculation-rules/10.92.11.208_admin_core_applicationgroup-dark.png'),
  }}
/>

## The Application Group List Page

Navigate to **Applications > Application Groups** from the main menu. 

You can think of the three tabs listed below as a potential workflow option for creating Application Groups: 

### Application Group Calculation Rules

Configure new Calculation Rules or run predefined rules. 

### Application Group Suggestions

Review the suggested Application Groups. 

The list of suggestions is created by Calculation Rules with outcomes set to **Suggest**. Suggestions are automatically generated by Application Components. 

For each suggestion, you can click **Accept** or **Ignore** right in the list. If you choose **Ignore**, an **Undo** option appears so you can revert the action.

### My Application Groups

Process the accepted Application Groups. 

Application Groups are generated based on Calculation Rules with outcomes set to **Auto-Create**. View charts of group dependencies and use the groups as components to build [Business Services](/apps/business-services). 

<ThemedImage
  alt="Docusaurus themed image"
  sources={{
    light: useBaseUrl('/assets/images/calculation-rules/calculation-rules-list-page-light.png'),
    dark: useBaseUrl('/assets/images/calculation-rules/calculation-rules-list-page-dark.png'),
  }}
/>

### Predefined Calculation Rules

There are three predefined Calculation Rules: Database, LB VIP, and Database Server. These rules are designed to help you quickly create Application Groups based on common use cases.

- The **Database** Calculation Rule will automatically create Application Groups filtered by database instance. It leverages Device42's Database Discovery to show you relationships between your application and database instances throughout the database server.
- The **Load Balancer VIP** Calculation Rule will create Application Groups for each VIP discovered on a load balancer. VIPs are often the primary entry point into an application, so this filter will offer an outside-in perspective of the application's dependencies.
- The **Database Server** Calculation Rule will mimic today's current default Application Group filter and show you the dependencies down to the database server level. This is helpful for full SQL server migrations and for users unable to perform level-three database discovery.

To use the predefined rules, select one and click **Process Now**. 

<ThemedImage
  alt="Docusaurus themed image"
  sources={{
    light: useBaseUrl('/assets/images/calculation-rules/predefined-process-now-light.png'),
    dark: useBaseUrl('/assets/images/calculation-rules/predefined-process-now-dark.png'),
  }} 
/>

## Create a New Calculation Rule

Under the **Application Group Calculation Rules** tab, click the **Create** button to access the New Application Filter page and fill in the **Name**.

Choose the **Outcome** of the Application Group that will be created based on the rule:
  - **Auto-Create**: Select this if you're confident that you'll want to use the Application Group resulting from this new rule. The resulting group will be added to the list under the **My Application Groups** tab.
  - **Suggest**: Select this if you're not sure if you want to use the Application Group resulting from this new rule. The resulting group will be added to the list under the **Application Group Suggestions** tab, where you'll have the option to **Accept** or **Ignore** the suggested group.

  <ThemedImage
    alt="Docusaurus themed image"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/new-rule-outcome-starting-points-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/new-rule-outcome-starting-points-dark.png'),
    }}
  />

### Starting Points: Criteria

Select a Starting Point that's as close to the application as you can define it. You can think of the Starting Point as an indication of what's important. This could be a service, database, or Saturn application, for example. You can select specific fixed items or define search criteria to find matching items.

It's a good idea to tag applications that are central to your environment and then add a filter to include the tagged items as a Starting Point.

Under **Starting Points**, you'll see two options: **Criteria** and **Fixed**.

- Select **Criteria** to define types and categories of items to be included for the group's Starting Points. For example, you could define broad criteria to include physical devices.

  - Select an **Object Type** and apply filters to the object type to narrow down the criteria. 
            
    <ThemedImage
      alt="Docusaurus themed image"
      sources={{
        light: useBaseUrl('/assets/images/calculation-rules/search-criteria-light.png'),
        dark: useBaseUrl('/assets/images/calculation-rules/search-criteria-dark.png'),
      }}
    />

  - You could add a **Tags** filter and apply a partial search filter to find tags that contain a specific name fragment by adding the fragment to the **Contains** text box. For example, you could apply a filter for devices that have `App_` in their names.

    <ThemedImage
      alt="Docusaurus themed image"
      sources={{
        light: useBaseUrl('/assets/images/calculation-rules/tag-search-criteria-light.png'),
        dark: useBaseUrl('/assets/images/calculation-rules/tag-search-criteria-dark.png'),
      }}
    />

- Add multiple criteria and designate at least one of the criteria as **Required** to ensure that matching items are included in the dependency mapping.

    <ThemedImage
      alt="Docusaurus themed image"
      sources={{
        light: useBaseUrl('/assets/images/calculation-rules/required-light.png'),
        dark: useBaseUrl('/assets/images/calculation-rules/required-dark.png'),
      }}
    />

### Starting Points: Fixed
  
Select **Fixed** to include specific items as definitive Starting Points, rather than electing items of a similar type (criteria). Use the object type search boxes to enter and find the item(s) you want to use as Starting Points.

  <ThemedImage
    alt="Docusaurus themed image"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/fixed-object-types-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/fixed-object-types-dark.png'),
    }}
    style={{ width: '35%' }} 
  />

### Group By and Tags LIKE Options

The **Group By** field is required if you choose the **Criteria** option for the Starting Point. The **Group By** criteria creates multiple Application Groups from one rule.

Use the `%` wildcard in the **Tags LIKE** field to find items that match part of a tag name. For example, enter `app_%` to include items with tags that start with `app_`.
  
<ThemedImage
  alt="Docusaurus themed image"
  sources={{
    light: useBaseUrl('/assets/images/calculation-rules/new-rule-group-by-logic-light.png'),
    dark: useBaseUrl('/assets/images/calculation-rules/new-rule-group-by-logic-dark.png'),
  }}
/>

### Calculation Logic Templates

Calculation Logic Templates set the traversal logic of Calculation Rules. Device42 needs to know how you want to define and calculate the dependencies and determine what is and is not considered in the group. You can use the default Device42 template or create a new template.

The **Calculation Logic Template** allows you to add multiple rules and conditions to groups in a user-friendly interface. You can create templates that target different parts of your environment, such as active traffic or Active Directory, or a template that does both.

Add a new logic template from the Calculation Rule add or edit form, or go to **Applications > Application Groups**, click the **Settings** button, and select **Create Calculation Logic Template**. 

From the template list page, click **Create Calculation Logic Template**. 

We recommended you select the **Form** format from the dropdown, but we've added the **DOQL** format option for backward compatibility with the formats used before the logic template was introduced.

  <ThemedImage
    alt="Docusaurus themed image"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/form-logic-template-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/form-logic-template-dark.png'),
    }}
  />

Fill in the fields:

- **Name**: Enter a name for the template.
- **Time Period (in days)**: Choose a relatively recent time period, when you know that active communication has occurred, like 30 days.
- **Levels of Depth**: Set the maximum number of connections a node can have. To avoid including the dependencies of dependencies, we recommend `5` for regular environments, but you can increase the value for very complex environments.
- **Limit of connections**: Limit the number of connections to avoid getting into any infrastructure services, like an Active Directory or backup server. You can increase the value for applications that are very noisy.
- **End at**: Specify where the calculation will ‘end’. 
  - Select **Database** to end the calculation at the database level. If you select this option, and your selected starting point is a database, the Application Group will continue mapping based on the rest of the rules.
  - Select **Load Balancer Virtual IP** if that's where your application stops.
  :::note
  In 19.06, we fixed the issue where Application Group connections to database services were missing in the visualization when the calculation started at the database level and the **End at** option was enabled.
  :::
- **Start at**: Specify where the calculation will start.
- **Include**: Include the selected items *to the exclusion* of everything else. You can generally leave this option blank unless you have a specific reason to limit the calculation to specific items. For example, you can choose to include only devices that are in production. 
- **Exclude**: Select categories that it doesn't make sense to include in the calculation. You can exclude resources, devices, services, or Application Components. For example, you can exclude IPv6 traffic or port 22.

Save and run the Calculation Logic Template by clicking **Process Now**.

  <ThemedImage
    alt="Process Calculation Logic Template"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/template-process-now-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/template-process-now-dark.png'),
    }}
  />

### Visualization Options

The Calculation Rule **Visualization** option determines the default chart depth rendered, which is useful for large environments where you want to limit the levels of dependencies shown in the visualization.

Leave the **Visualization** option blank to include all levels of dependencies in the Application Group and dependency visualization, or enter a value to limit the number of levels shown.


  <ThemedImage
    alt="Docusaurus themed image"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/new-rule-logic-viz-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/new-rule-logic-viz-dark.png'),
    }}
  />

Toggle on the **Store and Display Connection Metadata** option to display communication lines and data (like the IP address and port) between boxes in the Application Group chart.

  ![Connection Metadata](/assets/images/calculation-rules/viz-metadata.png)


## Processing Calculation Rules  

Process one or many Calculation Rules to generate Application Groups and Suggestions at any time. **Enabled** Calculation Rules are also processed nightly at 2 AM. 

You can process a Calculation Rule from its details page by choosing the process option from the **Actions** menu or finding the process option from the ellipsis menu on the Application Groups list page.

- Click the **Process Now** button at the top-right of a saved Calculation Rule to run it immediately.

  <ThemedImage
    alt="Docusaurus themed image"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/process-now-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/process-now-dark.png'),
    }}
  />

- Select one or more Calculation Rules from the Application Groups list page and select **Run Background Processing** from the **Actions** dropdown.

  <ThemedImage
    alt="Docusaurus themed image"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/run-background-processing-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/run-background-processing-dark.png'),
    }}
  />

- Click the ellipsis menu and select **Run Background Processing**.

  <ThemedImage
    alt="Docusaurus themed image"
    sources={{
      light: useBaseUrl('/assets/images/calculation-rules/ellipsis-menu-light.png'),
      dark: useBaseUrl('/assets/images/calculation-rules/ellipsis-menu-dark.png'),
    }}
  />

There are four statuses for Calculation Rules: **Processing..**, **Completed**, **Failed**, and **Warnings**. Hover over the **i** icon for more details.

<img src={statusImage} width='60%'/>

## Bulk Apply Logic Templates

You can apply a Calculation Logic Template to multiple Calculation Rules at once. From the Application Group Calculation Rules tab, under the **Actions** menu, select the **Set Calculation Template**.

  <ThemedImage
    alt="Bulk Apply Calculation Logic Templates"
    sources={{
      light: useBaseUrl('/assets/images/application-groups/ag-bulk-apply-templates-light.png'),
      dark: useBaseUrl('/assets/images/application-groups/ag-bulk-apply-templates-dark.png'),
    }}
  />

## (Legacy) Creating a New Calculation Rule

- Click **+ Add** at the top right of the list page to add a new AppFocus Filter.

  ![](/assets/images/D42-24410_AG-filters-add-page-1-AH.png)

- Enter a **Name** for the filter and select the **Outcome** you want, either **Auto-Create** or **Suggest**. The **Suggest** option adds the filter to the list but does not include it when Device42 generates Application Groups during nightly processing. **Auto-Create** includes the filter in Application Group processing.

- Click **+ Add More** in the bottom-right corner of the **Rules** section (a filter must have at least one rule), select the **Object Type** for the rule, and then click **Modify Search**.

  ![](/assets/images/D42-24410_AG-filters-addserach-criteria-3.png)

- Use the filters in the Search Criteria window to define which resource or device types you want for the rule. You can also use the Advanced Search feature (binocular icon) to build a search. Click **OK** to save the rule.

  ![](/assets/images/D42-24410_AG-filters-addserach-criteria-4-AH.png)

- Device42 displays the Search Criteria text for the resource or device rule.

  ![](/assets/images/D42-24410_AG-filters-addserach-criteria-5-AH.png)

- Select a **Group By** value or values for the filter. **Group By** will enable multiple AppFocus Application Groups to be generated from one rule. The available **Group By** options will change as different object types are added to the filter's rules.
- You can also group by **Tags LIKE** values.

  ![](/assets/images/D42-24410_AG-filters-addserach-criteria-6-group-by-AH.png)

- You can add additional rules to the AppFocus filter if you want, and you can include rules for both devices and resources. Use the trash icon to delete a rule.
- Click **Save** at the top right of the page to save and add the filter to the AppFocus list page. If you selected the **Auto-Create** outcome for the filter, Device42 will calculate one or more Application Groups during nightly processing.
  
